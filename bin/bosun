#!/usr/bin/env bash
#
# bosun - Helm for home
#
# Usage: bosun <command> [args]
#
set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Find project root (where bosun/ directory lives)
find_root() {
    local dir="$PWD"
    while [[ "$dir" != "/" ]]; do
        if [[ -d "$dir/bosun" ]] && [[ -f "$dir/bosun/docker-compose.yml" ]]; then
            echo "$dir"
            return 0
        fi
        dir="$(dirname "$dir")"
    done
    echo ""
}

ROOT=$(find_root)
COMPOSE_FILE="${ROOT:-.}/bosun/docker-compose.yml"
MANIFEST_DIR="${ROOT:-.}/manifest"

# Help text
usage() {
    cat << 'EOF'
bosun - Helm for home

SETUP
  init                  Christen your yacht (interactive setup wizard)

YACHT COMMANDS
  yacht up              Start the yacht (docker compose up -d)
  yacht down            Dock the yacht (docker compose down)
  yacht restart         Quick turnaround
  yacht status          Check if we're seaworthy

CREW COMMANDS
  crew list             Show all hands on deck (docker ps)
  crew logs [name]      Tail crew member logs
  crew inspect [name]   Detailed crew info
  crew restart [name]   Send crew member for coffee break

MANIFEST COMMANDS
  provision [stack]     Render manifest to compose/traefik/gatus
    --dry-run, -n       Show what would be generated without writing
    --diff, -d          Show diff against existing output files
  provisions            List available provisions
  create <tmpl> <name>  Scaffold new service (webapp, api, worker, static)

COMMS COMMANDS
  radio test            Test webhook endpoint
  radio status          Check Tailscale/tunnel status

DIAGNOSTICS
  status                Health dashboard - crew, infra, resources
  doctor                Pre-flight checks - is the ship seaworthy?
  lint                  Validate all manifests before deploy

EMERGENCY
  mayday                Show recent errors across all crew
  overboard [name]      Force remove a problematic container

OPTIONS
  -h, --help            Show this help
  -v, --version         Show version
EOF
}

# Yacht commands
cmd_yacht() {
    local action="${1:-status}"

    case "$action" in
        up)
            # Check if traefik is running (if we're using reverse proxy)
            if docker ps --format '{{.Names}}' 2>/dev/null | grep -q "^traefik$"; then
                echo -e "${GREEN}‚úì Traefik is running${NC}"
            elif docker ps -a --format '{{.Names}}' 2>/dev/null | grep -q "^traefik$"; then
                echo -e "${YELLOW}‚ö† Traefik exists but is not running. Starting it first...${NC}"
                docker start traefik 2>/dev/null || true
            else
                echo -e "${YELLOW}‚ö† Traefik not found - reverse proxy won't work until traefik is deployed${NC}"
            fi

            echo -e "${GREEN}‚öì Raising anchor...${NC}"
            docker compose -f "$COMPOSE_FILE" up -d "${@:2}"
            echo -e "${GREEN}‚öì Yacht is underway!${NC}"
            ;;
        down)
            echo -e "${YELLOW}‚öì Dropping anchor...${NC}"
            docker compose -f "$COMPOSE_FILE" down "${@:2}"
            echo -e "${YELLOW}‚öì Yacht is docked.${NC}"
            ;;
        restart)
            echo -e "${BLUE}‚öì Quick turnaround...${NC}"
            docker compose -f "$COMPOSE_FILE" restart "${@:2}"
            ;;
        status)
            docker compose -f "$COMPOSE_FILE" ps
            ;;
        *)
            echo -e "${RED}Unknown yacht command: $action${NC}"
            echo "Try: up, down, restart, status"
            exit 1
            ;;
    esac
}

# Crew commands
cmd_crew() {
    local action="${1:-list}"

    case "$action" in
        list)
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" "${@:2}"
            ;;
        logs)
            if [[ -z "${2:-}" ]]; then
                echo -e "${RED}Specify crew member name${NC}"
                exit 1
            fi
            docker logs -f "$2" "${@:3}"
            ;;
        inspect)
            if [[ -z "${2:-}" ]]; then
                echo -e "${RED}Specify crew member name${NC}"
                exit 1
            fi
            docker inspect "$2" "${@:3}"
            ;;
        restart)
            if [[ -z "${2:-}" ]]; then
                echo -e "${RED}Specify crew member name${NC}"
                exit 1
            fi
            echo -e "${BLUE}‚òï Sending $2 for a coffee break...${NC}"
            docker restart "$2"
            ;;
        *)
            echo -e "${RED}Unknown crew command: $action${NC}"
            echo "Try: list, logs, inspect, restart"
            exit 1
            ;;
    esac
}

# Manifest/provision commands
cmd_provision() {
    local dry_run=false
    local diff_only=false
    local stack=""

    # Parse flags
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --dry-run|-n)
                dry_run=true
                shift
                ;;
            --diff|-d)
                diff_only=true
                dry_run=true
                shift
                ;;
            *)
                stack="$1"
                shift
                ;;
        esac
    done

    if [[ -z "$stack" ]]; then
        echo -e "${RED}Specify a stack to provision${NC}"
        echo "Example: bosun provision stacks/apps.yml"
        echo "Options: --dry-run, --diff"
        exit 1
    fi

    cd "$MANIFEST_DIR"

    if [[ "$dry_run" == true ]]; then
        echo -e "${BLUE}üîç Dry run - showing what would change...${NC}"
        echo ""

        # Generate to temp directory
        local temp_dir=$(mktemp -d)
        trap "rm -rf $temp_dir" EXIT

        # Get the stack name for output file naming
        local stack_name=$(basename "$stack" .yml)

        # Render to temp
        uv run manifest.py render "$stack" --dry-run > "$temp_dir/output.yml" 2>&1

        if [[ "$diff_only" == true ]]; then
            # Show diff against existing files
            local output_dir="$MANIFEST_DIR/output"

            if [[ ! -d "$output_dir" ]]; then
                echo -e "${YELLOW}No existing output directory - all files would be new${NC}"
                echo ""
                cat "$temp_dir/output.yml"
                return 0
            fi

            echo -e "${BLUE}Changes that would be applied:${NC}"
            echo ""

            # Parse the YAML output and compare each section
            local has_changes=false

            for target in compose traefik gatus; do
                local existing_file=""
                case "$target" in
                    compose) existing_file="$output_dir/compose/${stack_name}.yml" ;;
                    traefik) existing_file="$output_dir/traefik/dynamic.yml" ;;
                    gatus) existing_file="$output_dir/gatus/endpoints.yml" ;;
                esac

                if [[ -f "$existing_file" ]]; then
                    # Extract section from dry-run output
                    # The dry-run format is: target:\n  content (2-space indent)
                    # We need to extract and de-indent
                    local section_start=$(grep -n "^${target}:" "$temp_dir/output.yml" | cut -d: -f1)
                    if [[ -n "$section_start" ]]; then
                        # Get next section or end of file
                        local next_section=$(tail -n +$((section_start + 1)) "$temp_dir/output.yml" | grep -n "^[a-z]*:" | head -1 | cut -d: -f1)
                        if [[ -n "$next_section" ]]; then
                            local section_end=$((section_start + next_section - 1))
                            # Extract section, skip the header line, and remove 2-space indent
                            sed -n "$((section_start + 1)),${section_end}p" "$temp_dir/output.yml" | sed 's/^  //' > "$temp_dir/${target}.yml"
                        else
                            # Extract to end of file
                            tail -n +$((section_start + 1)) "$temp_dir/output.yml" | sed 's/^  //' > "$temp_dir/${target}.yml"
                        fi

                        # Compare
                        if ! diff -q "$existing_file" "$temp_dir/${target}.yml" > /dev/null 2>&1; then
                            echo -e "${YELLOW}‚îÅ‚îÅ‚îÅ $target ($existing_file) ‚îÅ‚îÅ‚îÅ${NC}"
                            diff --color=always -u "$existing_file" "$temp_dir/${target}.yml" 2>/dev/null || \
                                diff -u "$existing_file" "$temp_dir/${target}.yml"
                            echo ""
                            has_changes=true
                        fi
                    fi
                else
                    echo -e "${GREEN}+ New file would be created: $existing_file${NC}"
                    has_changes=true
                fi
            done

            if [[ "$has_changes" == false ]]; then
                echo -e "${GREEN}‚úì No changes - output is already up to date${NC}"
            fi
        else
            # Just show what would be generated
            echo -e "${BLUE}Would generate:${NC}"
            echo ""
            cat "$temp_dir/output.yml"
        fi
    else
        echo -e "${GREEN}üì¶ Provisioning $stack...${NC}"
        uv run manifest.py render "$stack"
    fi
}

cmd_provisions() {
    echo -e "${BLUE}Available provisions:${NC}"
    cd "$MANIFEST_DIR"
    uv run manifest.py provisions
}

# Create command - scaffold new services from templates
cmd_create() {
    local template="${1:-}"
    local name="${2:-}"

    if [[ -z "$template" ]] || [[ -z "$name" ]]; then
        echo -e "${BLUE}Usage: bosun create <template> <name>${NC}"
        echo ""
        echo "Available templates:"
        echo "  webapp     Web app with reverse proxy, health checks, monitoring"
        echo "  api        API service with database"
        echo "  worker     Background worker (no reverse proxy)"
        echo "  static     Static site (nginx)"
        echo ""
        echo "Example: bosun create webapp myapp"
        return 1
    fi

    local output_file="$MANIFEST_DIR/services/${name}.yml"

    if [[ -f "$output_file" ]]; then
        echo -e "${RED}Service already exists: $output_file${NC}"
        return 1
    fi

    echo -e "${GREEN}üîß Creating $name from $template template...${NC}"

    case "$template" in
        webapp)
            cat > "$output_file" << EOF
# ${name} - Web Application
name: ${name}

provisions:
  - webapp

config:
  image: ghcr.io/org/${name}:latest
  port: 3000
  subdomain: ${name}
  domain: example.com
  group: Apps
  icon: mdi-application
  description: ${name} web application
EOF
            ;;
        api)
            cat > "$output_file" << EOF
# ${name} - API Service
name: ${name}

provisions:
  - webapp

services:
  postgres:
    version: "17"
    db: ${name}
    db_password: "\${{ secrets.apps.${name}.db_password }}"

config:
  image: ghcr.io/org/${name}:latest
  port: 8080
  subdomain: api-${name}
  domain: example.com
  group: APIs
  icon: mdi-api
  description: ${name} API
EOF
            ;;
        worker)
            cat > "$output_file" << EOF
# ${name} - Background Worker
name: ${name}

provisions:
  - container

config:
  image: ghcr.io/org/${name}:latest
EOF
            ;;
        static)
            cat > "$output_file" << EOF
# ${name} - Static Site
name: ${name}

provisions:
  - webapp

config:
  image: nginx:alpine
  port: 80
  subdomain: ${name}
  domain: example.com
  group: Sites
  icon: mdi-web
  description: ${name} static site
EOF
            ;;
        *)
            echo -e "${RED}Unknown template: $template${NC}"
            echo "Try: webapp, api, worker, static"
            return 1
            ;;
    esac

    echo -e "${GREEN}‚úì${NC} Created: $output_file"
    echo ""
    echo "Next steps:"
    echo "  1. Edit $output_file to customize"
    echo "  2. Add to a stack in manifest/stacks/"
    echo "  3. Run 'bosun provision --dry-run stacks/yourstack.yml'"
}

# Status command - unified health dashboard
cmd_status() {
    echo -e "${BLUE}‚öì Yacht Status Dashboard${NC}"
    echo ""

    # Container status
    echo -e "${BLUE}‚îÅ‚îÅ‚îÅ Crew Status ‚îÅ‚îÅ‚îÅ${NC}"
    if command -v docker &> /dev/null && docker info &> /dev/null; then
        local running=$(docker ps -q 2>/dev/null | wc -l | tr -d ' ')
        local total=$(docker ps -aq 2>/dev/null | wc -l | tr -d ' ')
        local unhealthy=$(docker ps --filter "health=unhealthy" -q 2>/dev/null | wc -l | tr -d ' ')

        echo -e "  Containers: ${GREEN}$running running${NC} / $total total"
        if [[ "$unhealthy" -gt 0 ]]; then
            echo -e "  Health: ${RED}$unhealthy unhealthy${NC}"
            docker ps --filter "health=unhealthy" --format "    {{.Names}}: {{.Status}}" 2>/dev/null
        else
            echo -e "  Health: ${GREEN}All healthy${NC}"
        fi

        # Show key infrastructure
        echo ""
        echo -e "${BLUE}‚îÅ‚îÅ‚îÅ Infrastructure ‚îÅ‚îÅ‚îÅ${NC}"
        for svc in traefik authelia gatus; do
            if docker ps --format '{{.Names}}' 2>/dev/null | grep -q "^${svc}$"; then
                local status=$(docker inspect --format '{{.State.Health.Status}}' "$svc" 2>/dev/null || echo "running")
                if [[ "$status" == "healthy" ]] || [[ "$status" == "running" ]]; then
                    echo -e "  ${GREEN}‚óè${NC} $svc"
                else
                    echo -e "  ${YELLOW}‚óè${NC} $svc ($status)"
                fi
            else
                echo -e "  ${RED}‚óã${NC} $svc (not running)"
            fi
        done

        # Show app containers
        echo ""
        echo -e "${BLUE}‚îÅ‚îÅ‚îÅ Applications ‚îÅ‚îÅ‚îÅ${NC}"
        docker ps --format "{{.Names}}" 2>/dev/null | grep -vE "^(traefik|authelia|gatus|bosun)$" | while read -r container; do
            local status=$(docker inspect --format '{{.State.Health.Status}}' "$container" 2>/dev/null || echo "running")
            local uptime=$(docker ps --filter "name=^${container}$" --format "{{.Status}}" 2>/dev/null | head -1)
            if [[ "$status" == "healthy" ]] || [[ "$status" == "running" ]]; then
                echo -e "  ${GREEN}‚óè${NC} $container ($uptime)"
            elif [[ "$status" == "unhealthy" ]]; then
                echo -e "  ${RED}‚óè${NC} $container (unhealthy)"
            else
                echo -e "  ${YELLOW}‚óè${NC} $container ($status)"
            fi
        done
    else
        echo -e "  ${RED}Docker not available${NC}"
    fi

    # Resource usage
    echo ""
    echo -e "${BLUE}‚îÅ‚îÅ‚îÅ Resources ‚îÅ‚îÅ‚îÅ${NC}"
    if command -v docker &> /dev/null; then
        # Get total memory and CPU from docker stats (quick snapshot)
        local stats=$(docker stats --no-stream --format "{{.MemUsage}}" 2>/dev/null | head -5)
        if [[ -n "$stats" ]]; then
            local mem_total=$(docker stats --no-stream --format "{{.MemPerc}}" 2>/dev/null | awk '{sum+=$1} END {printf "%.1f", sum}')
            local cpu_total=$(docker stats --no-stream --format "{{.CPUPerc}}" 2>/dev/null | awk '{sum+=$1} END {printf "%.1f", sum}')
            echo -e "  Memory: ${mem_total}% used by containers"
            echo -e "  CPU: ${cpu_total}% used by containers"
        else
            echo -e "  ${YELLOW}No container stats available${NC}"
        fi
    fi

    # Disk usage for volumes
    local volumes_size=$(docker system df --format "{{.Size}}" 2>/dev/null | tail -1 || echo "unknown")
    echo -e "  Volumes: $volumes_size"

    # Recent activity
    echo ""
    echo -e "${BLUE}‚îÅ‚îÅ‚îÅ Recent Activity ‚îÅ‚îÅ‚îÅ${NC}"
    docker ps -a --format "{{.Names}}\t{{.Status}}" 2>/dev/null | head -5 | while IFS=$'\t' read -r name status; do
        echo "  $name: $status"
    done

    echo ""
}

# Radio commands
cmd_radio() {
    local action="${1:-status}"

    case "$action" in
        test)
            echo -e "${BLUE}üìª Testing radio...${NC}"
            if curl -sf http://localhost:8080/health > /dev/null 2>&1; then
                echo -e "${GREEN}üìª Radio is loud and clear!${NC}"
            else
                echo -e "${RED}üìª Radio silence. Check webhook container.${NC}"
                exit 1
            fi
            ;;
        status)
            echo -e "${BLUE}üìª Checking comms...${NC}"
            if command -v tailscale &> /dev/null; then
                tailscale status
            else
                echo "Tailscale not installed locally"
            fi
            ;;
        *)
            echo -e "${RED}Unknown radio command: $action${NC}"
            echo "Try: test, status"
            exit 1
            ;;
    esac
}

# Doctor command - pre-flight checks
cmd_doctor() {
    echo -e "${BLUE}ü©∫ Running pre-flight checks...${NC}"
    echo ""

    local passed=0
    local failed=0
    local warned=0

    # Check: Docker
    if command -v docker &> /dev/null && docker info &> /dev/null; then
        echo -e "  ${GREEN}‚úì${NC} Docker is running"
        ((passed++))
    else
        echo -e "  ${RED}‚úó${NC} Docker is not running"
        ((failed++))
    fi

    # Check: Docker Compose v2
    if docker compose version &> /dev/null; then
        local compose_ver=$(docker compose version --short 2>/dev/null || echo "unknown")
        echo -e "  ${GREEN}‚úì${NC} Docker Compose v2 ($compose_ver)"
        ((passed++))
    else
        echo -e "  ${RED}‚úó${NC} Docker Compose v2 not found"
        ((failed++))
    fi

    # Check: Git
    if command -v git &> /dev/null; then
        echo -e "  ${GREEN}‚úì${NC} Git is installed"
        ((passed++))
    else
        echo -e "  ${RED}‚úó${NC} Git not found"
        ((failed++))
    fi

    # Check: Project root
    if [[ -n "$ROOT" ]]; then
        echo -e "  ${GREEN}‚úì${NC} Project root found: $ROOT"
        ((passed++))
    else
        echo -e "  ${YELLOW}‚ö†${NC} Project root not found (run from project directory)"
        ((warned++))
    fi

    # Check: Age key
    local age_key="${SOPS_AGE_KEY_FILE:-$HOME/.config/sops/age/keys.txt}"
    if [[ -f "$age_key" ]]; then
        echo -e "  ${GREEN}‚úì${NC} Age key found: $age_key"
        ((passed++))
    else
        echo -e "  ${YELLOW}‚ö†${NC} Age key not found at $age_key"
        echo -e "      Run: ${BLUE}age-keygen -o $age_key${NC}"
        ((warned++))
    fi

    # Check: SOPS
    if command -v sops &> /dev/null; then
        local sops_ver=$(sops --version 2>/dev/null | head -1 || echo "unknown")
        echo -e "  ${GREEN}‚úì${NC} SOPS is installed ($sops_ver)"
        ((passed++))
    else
        echo -e "  ${YELLOW}‚ö†${NC} SOPS not found (needed for secrets)"
        ((warned++))
    fi

    # Check: uv (for manifest)
    if command -v uv &> /dev/null; then
        echo -e "  ${GREEN}‚úì${NC} uv is installed"
        ((passed++))
    else
        echo -e "  ${YELLOW}‚ö†${NC} uv not found (needed for manifest rendering)"
        ((warned++))
    fi

    # Check: Manifest directory
    if [[ -d "$MANIFEST_DIR" ]] && [[ -f "$MANIFEST_DIR/manifest.py" ]]; then
        echo -e "  ${GREEN}‚úì${NC} Manifest directory found"
        ((passed++))
    else
        echo -e "  ${YELLOW}‚ö†${NC} Manifest directory not found"
        ((warned++))
    fi

    # Check: Webhook endpoint (optional)
    if curl -sf http://localhost:8080/health &> /dev/null; then
        echo -e "  ${GREEN}‚úì${NC} Webhook endpoint responding"
        ((passed++))
    else
        echo -e "  ${YELLOW}‚ö†${NC} Webhook not responding (bosun container not running?)"
        ((warned++))
    fi

    # Summary
    echo ""
    echo -e "Summary: ${GREEN}$passed passed${NC}, ${YELLOW}$warned warnings${NC}, ${RED}$failed failed${NC}"

    if [[ $failed -gt 0 ]]; then
        echo -e "\n${RED}‚öì Ship not seaworthy! Fix errors above.${NC}"
        return 1
    elif [[ $warned -gt 0 ]]; then
        echo -e "\n${YELLOW}‚öì Ship can sail, but check warnings.${NC}"
        return 0
    else
        echo -e "\n${GREEN}‚öì All systems go! Ready to sail.${NC}"
        return 0
    fi
}

# Lint command - validate manifests
cmd_lint() {
    local target="${1:-all}"

    echo -e "${BLUE}üîç Linting manifests...${NC}"
    echo ""

    local errors=0

    if [[ ! -d "$MANIFEST_DIR" ]]; then
        echo -e "${RED}‚úó Manifest directory not found${NC}"
        return 1
    fi

    # Check provisions exist
    if [[ ! -d "$MANIFEST_DIR/provisions" ]]; then
        echo -e "${RED}‚úó Provisions directory not found${NC}"
        ((errors++))
    else
        local provision_count=$(find "$MANIFEST_DIR/provisions" -name "*.yml" | wc -l | tr -d ' ')
        echo -e "${GREEN}‚úì${NC} Found $provision_count provisions"
    fi

    # Validate each service manifest
    if [[ -d "$MANIFEST_DIR/services" ]]; then
        echo -e "\nValidating services:"
        for service in "$MANIFEST_DIR/services"/*.yml; do
            [[ -f "$service" ]] || continue
            local name=$(basename "$service")

            # Check required fields
            if grep -q "^name:" "$service" && grep -q "^provisions:" "$service"; then
                # Try dry-run render
                if cd "$MANIFEST_DIR" && uv run manifest.py render "$service" --dry-run &> /dev/null; then
                    echo -e "  ${GREEN}‚úì${NC} $name"
                else
                    echo -e "  ${RED}‚úó${NC} $name (render failed)"
                    ((errors++))
                fi
            else
                echo -e "  ${RED}‚úó${NC} $name (missing name or provisions)"
                ((errors++))
            fi
        done
    fi

    # Validate each stack
    if [[ -d "$MANIFEST_DIR/stacks" ]]; then
        echo -e "\nValidating stacks:"
        for stack in "$MANIFEST_DIR/stacks"/*.yml; do
            [[ -f "$stack" ]] || continue
            local name=$(basename "$stack")

            # Check include exists
            if grep -q "^include:" "$stack"; then
                # Try dry-run render
                if cd "$MANIFEST_DIR" && uv run manifest.py render "$stack" --dry-run &> /dev/null; then
                    echo -e "  ${GREEN}‚úì${NC} $name"
                else
                    echo -e "  ${RED}‚úó${NC} $name (render failed)"
                    ((errors++))
                fi
            else
                echo -e "  ${YELLOW}‚ö†${NC} $name (no include section)"
            fi
        done
    fi

    # Validate dependencies in rendered output
    echo -e "\nValidating dependencies:"
    local dep_warnings=0

    for stack in "$MANIFEST_DIR/stacks"/*.yml; do
        [[ -f "$stack" ]] || continue
        local stack_name=$(basename "$stack" .yml)

        # Render and check dependencies
        local rendered=$(cd "$MANIFEST_DIR" && uv run manifest.py render "$stack" --dry-run 2>/dev/null)

        # Extract service names (lines like "    servicename:" with 4-space indent under services:)
        local services=$(echo "$rendered" | grep -E "^    [a-z][a-z0-9-]+:$" | sed 's/://g' | tr -d ' ' || true)

        # Check: services with -db suffix should be in depends_on of their parent
        for svc in $services; do
            if [[ "$svc" == *-db ]]; then
                local parent="${svc%-db}"
                # Check if parent service exists and has depends_on
                if echo "$services" | grep -q "^${parent}$"; then
                    if ! echo "$rendered" | sed -n "/^    ${parent}:/,/^    [a-z]/p" | grep -q "depends_on:" 2>/dev/null; then
                        echo -e "  ${YELLOW}‚ö†${NC} $stack_name: $parent may be missing depends_on: $svc"
                        ((dep_warnings++))
                    fi
                fi
            fi
        done

        # Check: services with traefik labels should be on proxynet
        for svc in $services; do
            # Get this service's section
            local svc_section=$(echo "$rendered" | sed -n "/^    ${svc}:/,/^    [a-z]/p")
            if echo "$svc_section" | grep -q "traefik.enable"; then
                if ! echo "$svc_section" | grep -q "proxynet"; then
                    echo -e "  ${YELLOW}‚ö†${NC} $stack_name: $svc has traefik labels but may not be on proxynet"
                    ((dep_warnings++))
                fi
            fi
        done
    done

    if [[ $dep_warnings -eq 0 ]]; then
        echo -e "  ${GREEN}‚úì${NC} All dependencies look correct"
    fi

    # Summary
    echo ""
    if [[ $errors -gt 0 ]]; then
        echo -e "${RED}Found $errors error(s). Fix before deploying.${NC}"
        return 1
    else
        echo -e "${GREEN}‚úì All manifests valid!${NC}"
        return 0
    fi
}

# Init command - interactive setup wizard
cmd_init() {
    local target_dir="${1:-.}"

    echo -e "${GREEN}‚öì Christening your yacht...${NC}"
    echo ""

    # Check if already initialized
    if [[ -d "$target_dir/bosun" ]] && [[ -f "$target_dir/bosun/docker-compose.yml" ]]; then
        echo -e "${YELLOW}‚ö† This directory already has a bosun project.${NC}"
        read -p "Reinitialize? This won't overwrite existing files. [y/N] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Aborted."
            exit 0
        fi
    fi

    # Step 1: Create directory structure
    echo -e "${BLUE}üìÅ Creating project structure...${NC}"
    mkdir -p "$target_dir/bosun/scripts"
    mkdir -p "$target_dir/manifest/provisions"
    mkdir -p "$target_dir/manifest/services"
    mkdir -p "$target_dir/manifest/stacks"
    echo -e "  ${GREEN}‚úì${NC} Created directories"

    # Step 2: Check/setup age key
    local age_key="${SOPS_AGE_KEY_FILE:-$HOME/.config/sops/age/keys.txt}"
    local age_pub=""

    echo -e "${BLUE}üîê Setting up encryption...${NC}"

    if [[ -f "$age_key" ]]; then
        echo -e "  ${GREEN}‚úì${NC} Age key found: $age_key"
        age_pub=$(grep "public key:" "$age_key" 2>/dev/null | cut -d: -f2 | tr -d ' ' || age-keygen -y "$age_key" 2>/dev/null)
    else
        if command -v age-keygen &> /dev/null; then
            echo -e "  ${YELLOW}‚ö†${NC} No age key found. Generating..."
            mkdir -p "$(dirname "$age_key")"
            age-keygen -o "$age_key" 2>&1 | tee /dev/stderr | grep "public key:" | cut -d: -f2 | tr -d ' ' > /tmp/age_pub_$$
            age_pub=$(cat /tmp/age_pub_$$)
            rm -f /tmp/age_pub_$$
            chmod 600 "$age_key"
            echo -e "  ${GREEN}‚úì${NC} Generated age key: $age_key"
        else
            echo -e "  ${RED}‚úó${NC} age-keygen not found. Install age first:"
            echo "      brew install age  # macOS"
            echo "      apt install age   # Debian/Ubuntu"
            age_pub="AGE-PUBLIC-KEY-REPLACE-ME"
        fi
    fi

    # Step 3: Create .sops.yaml if not exists
    if [[ ! -f "$target_dir/.sops.yaml" ]]; then
        cat > "$target_dir/.sops.yaml" << EOF
creation_rules:
  - path_regex: .*\\.yaml$
    age: ${age_pub:-AGE-PUBLIC-KEY-REPLACE-ME}
EOF
        echo -e "  ${GREEN}‚úì${NC} Created .sops.yaml"
    else
        echo -e "  ${YELLOW}‚ö†${NC} .sops.yaml already exists, skipping"
    fi

    # Step 4: Initialize git if needed
    echo -e "${BLUE}üìö Setting up version control...${NC}"
    if [[ ! -d "$target_dir/.git" ]]; then
        if command -v git &> /dev/null; then
            git init "$target_dir" > /dev/null 2>&1
            echo -e "  ${GREEN}‚úì${NC} Initialized git repository"
        else
            echo -e "  ${YELLOW}‚ö†${NC} Git not found, skipping"
        fi
    else
        echo -e "  ${GREEN}‚úì${NC} Git repository exists"
    fi

    # Step 5: Create starter files (only if they don't exist)
    echo -e "${BLUE}üìù Creating starter files...${NC}"

    # bosun docker-compose.yml
    if [[ ! -f "$target_dir/bosun/docker-compose.yml" ]]; then
        cat > "$target_dir/bosun/docker-compose.yml" << 'EOF'
# Bosun - GitOps webhook receiver
# This container receives webhooks and deploys your services

services:
  bosun:
    image: ghcr.io/cameronsjo/bosun:latest
    container_name: bosun
    restart: unless-stopped
    environment:
      TZ: ${TZ:-America/Chicago}
      WEBHOOK_SECRET: ${WEBHOOK_SECRET:-change-me}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${APPDATA:-./appdata}/bosun:/app/data
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  default:
    name: bosun-net
EOF
        echo -e "  ${GREEN}‚úì${NC} Created bosun/docker-compose.yml"
    fi

    # manifest/pyproject.toml
    if [[ ! -f "$target_dir/manifest/pyproject.toml" ]]; then
        cat > "$target_dir/manifest/pyproject.toml" << 'EOF'
[project]
name = "bosun-manifest"
version = "0.1.0"
description = "Service manifests for bosun"
requires-python = ">=3.11"
dependencies = [
    "pyyaml>=6.0",
]

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[tool.hatch.build.targets.wheel]
packages = ["."]
EOF
        echo -e "  ${GREEN}‚úì${NC} Created manifest/pyproject.toml"
    fi

    # Example service manifest
    if [[ ! -f "$target_dir/manifest/services/example.yml" ]]; then
        cat > "$target_dir/manifest/services/example.yml" << 'EOF'
# Example service manifest
# Replace with your actual service configuration
name: example

provisions:
  - container
  - healthcheck
  - reverse-proxy

config:
  image: nginx:alpine
  port: 80
  subdomain: example
  domain: example.com
  description: Example service
EOF
        echo -e "  ${GREEN}‚úì${NC} Created manifest/services/example.yml"
    fi

    # .gitignore
    if [[ ! -f "$target_dir/.gitignore" ]]; then
        cat > "$target_dir/.gitignore" << 'EOF'
# Secrets (encrypted files are OK)
*.yaml
!*.sops.yaml
secrets.yaml

# Python
__pycache__/
*.py[cod]
.venv/

# Output
manifest/output/

# OS
.DS_Store
Thumbs.db

# IDE
.idea/
.vscode/
EOF
        echo -e "  ${GREEN}‚úì${NC} Created .gitignore"
    fi

    # README.md
    if [[ ! -f "$target_dir/README.md" ]]; then
        cat > "$target_dir/README.md" << 'EOF'
# My Homelab

Managed by [bosun](https://github.com/cameronsjo/bosun) - Helm for home.

## Quick Start

```bash
# Check system
bosun doctor

# Start bosun webhook receiver
bosun yacht up

# Add services to manifest/services/
# Deploy with git push
```

## Structure

```
‚îú‚îÄ‚îÄ bosun/           # Webhook receiver
‚îú‚îÄ‚îÄ manifest/        # Service definitions
‚îÇ   ‚îú‚îÄ‚îÄ provisions/  # Reusable templates
‚îÇ   ‚îú‚îÄ‚îÄ services/    # Individual services
‚îÇ   ‚îî‚îÄ‚îÄ stacks/      # Service groups
‚îî‚îÄ‚îÄ .sops.yaml       # Encryption config
```
EOF
        echo -e "  ${GREEN}‚úì${NC} Created README.md"
    fi

    # Summary
    echo ""
    echo -e "${GREEN}‚öì Yacht christened! Here's your checklist:${NC}"
    echo ""
    echo "  1. Review .sops.yaml and update the age public key if needed"
    echo "  2. Edit manifest/services/example.yml or create your own"
    echo "  3. Run 'bosun doctor' to verify your setup"
    echo "  4. Run 'bosun yacht up' to start the webhook receiver"
    echo "  5. Push to git to deploy!"
    echo ""
    echo -e "${BLUE}Run 'bosun --help' for all commands.${NC}"
}

# Emergency commands
cmd_mayday() {
    echo -e "${RED}üÜò MAYDAY - Recent errors across all crew:${NC}"
    docker ps -q | xargs -I {} docker logs --tail 20 {} 2>&1 | grep -iE "(error|fatal|panic|exception)" | tail -50 || echo "No recent errors found"
}

cmd_overboard() {
    local name="${1:-}"

    if [[ -z "$name" ]]; then
        echo -e "${RED}Specify container to throw overboard${NC}"
        exit 1
    fi

    echo -e "${RED}üåä Man overboard! Removing $name...${NC}"
    docker rm -f "$name"
}

# Main
main() {
    if [[ $# -eq 0 ]]; then
        usage
        exit 0
    fi

    case "$1" in
        init|christen)
            cmd_init "${@:2}"
            ;;
        yacht|hoist)
            cmd_yacht "${@:2}"
            ;;
        crew|scallywags)
            cmd_crew "${@:2}"
            ;;
        provision|plunder)
            cmd_provision "${@:2}"
            ;;
        provisions|loot)
            cmd_provisions
            ;;
        create|forge)
            cmd_create "${@:2}"
            ;;
        radio|parrot)
            cmd_radio "${@:2}"
            ;;
        status|bridge)
            cmd_status
            ;;
        doctor|checkup)
            cmd_doctor
            ;;
        lint|inspect)
            cmd_lint "${@:2}"
            ;;
        mayday|mutiny)
            cmd_mayday
            ;;
        overboard|plank)
            cmd_overboard "${@:2}"
            ;;
        yarr)
            echo -e "${YELLOW}üè¥‚Äç‚ò†Ô∏è Ahoy! Ye found the secret pirate mode!${NC}"
            echo ""
            echo "Aliases for scallywags:"
            echo "  christen    ‚Üí init"
            echo "  hoist       ‚Üí yacht"
            echo "  scallywags  ‚Üí crew"
            echo "  plunder     ‚Üí provision"
            echo "  loot        ‚Üí provisions"
            echo "  forge       ‚Üí create"
            echo "  parrot      ‚Üí radio"
            echo "  bridge      ‚Üí status"
            echo "  checkup     ‚Üí doctor"
            echo "  inspect     ‚Üí lint"
            echo "  mutiny      ‚Üí mayday"
            echo "  plank       ‚Üí overboard"
            echo ""
            echo -e "${YELLOW}Now swab the deck! ü¶ú${NC}"
            ;;
        -h|--help|help)
            usage
            ;;
        -v|--version|version)
            echo "bosun 0.1.0"
            ;;
        *)
            echo -e "${RED}Unknown command: $1${NC}"
            echo "Run 'bosun --help' for usage"
            exit 1
            ;;
    esac
}

main "$@"
