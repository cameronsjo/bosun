# Architecture Council Review Results

**Date**: 2024-12-22
**Rating**: 9/10 (with required fixes)
**Verdict**: Strong foundation, moderate re-scoping required

## Participants

- **Participant A**: gpt-5.1 (OpenAI)
- **Participant B**: gemini-3-pro-preview (Google)
- **Participant C**: claude-sonnet-4.5 (Anthropic)
- **Participant D**: grok-4 (xAI)

---

## Consensus Points

### 1. Split Architecture: VALIDATED ✓

The Host Daemon + Webhook Container split is correct. Provides:
- Reliability (survives Docker restarts, Unraid parity checks)
- Security isolation (webhook can only trigger, not access keys)

### 2. Concurrency: BLOCKING FOR V1 ⚠️

**Must implement before release.** Cannot run parallel docker compose operations.

**Required mechanism**: Single-flight reconcile with coalescing
```go
type Reconciler struct {
    mu      sync.Mutex
    running bool
    pending bool  // dirty flag
}

// If trigger arrives while reconciling:
// 1. Set pending = true
// 2. Return immediately
// 3. After current reconcile finishes, check pending
// 4. If pending, run one more reconcile
```

### 3. Webhook Secret Injection: CRITICAL SECURITY FIX ⚠️

**Problem**: Storing `WEBHOOK_SECRET` in git-tracked docker-compose.yml is a vulnerability.

**Solution**: Daemon must inject the secret into the webhook container:
- Generate/read secret on daemon side
- Mount via tmpfs volume or secure env injection
- Secret never touches disk or git

### 4. Socket Audit Trail: REQUIRED ✓

Socket permissions (0660) are primary auth, but add:
- **SO_PEERCRED**: Log kernel-reported UID/PID of every caller
- **Input validation**: Treat socket messages as signals, not commands
- **Immutable audit log**: Who triggered what, when

### 5. TCP Support: KEEP WITH SAFEGUARDS ✓

Keep for rootless Podman and SELinux-restricted environments.

**Constraints**:
- Disabled by default
- Bind strictly to `127.0.0.1` or `::1`
- Require Bearer token (generated by daemon)
- Log warning on startup if enabled

### 6. Installation UX: WIZARD OVER PACKAGES ✓

No .deb/.rpm for v1. Instead:

**`bosun init` wizard**:
- Generate systemd/OpenRC unit files
- Create bosun user/group if missing
- Set permissions on socket
- Validate docker and encryption key access

**`bosun doctor`**:
- Verify SOPS key permissions
- Test git remote access
- Check Docker socket accessibility

### 7. Default Setup: POLLING-ONLY ✓

- Document polling as the default, recommended setup
- Webhook is "advanced opt-in"
- Reduces attack surface for most users

### 8. Scope Reduction for v1

**Defer to v1.1+**:
- Automated rollback (v1 rollback = `git revert` + push)
- Complex container health checking
- Active drift correction

**v1 behavior**: Event-driven deployment agent, NOT continuous state enforcer
- Reconcile when: git changes (poll/webhook) OR manual trigger
- Do NOT auto-restart manually stopped containers
- Rely on Docker's `restart: unless-stopped` for crash recovery

---

## Unresolved Dissents

### Drift Reporting

| Position | Participants |
|----------|--------------|
| Include drift detection (report only, no fix) | B |
| Defer to v2, adds complexity | A, C, D |

**Resolution**: Defer unless implementation is trivial.

### TCP Necessity

| Position | Participants |
|----------|--------------|
| Remove TCP entirely for v1 | A |
| Keep with heavy safeguards | B, C, D |

**Resolution**: Keep with safeguards (per majority). A's position noted as "purest" security stance.

---

## Required Changes Summary

| Item | Priority | Status |
|------|----------|--------|
| Implement reconcile mutex + dirty flag | P0 | TODO |
| SO_PEERCRED audit logging | P0 | TODO |
| Daemon-injected webhook secret | P0 | TODO |
| TCP disabled by default + bearer token | P1 | TODO |
| `bosun init` wizard generates unit files | P1 | TODO |
| Document polling-only as default | P1 | TODO |
| Defer automated rollback to v1.1 | - | DECIDED |
| No drift correction in v1 | - | DECIDED |

---

## Updated Design Principles

1. **Event-driven, not continuous**: Bosun deploys on events, doesn't enforce state
2. **Polling is default**: Webhook is opt-in for advanced users
3. **Daemon owns secrets**: Webhook container receives secrets at runtime, never stores them
4. **Audit everything**: Every trigger logged with caller identity (SO_PEERCRED)
5. **Fail safe**: No parallel reconciles, mutex protects compose operations
